appTodos.directive("passwordConfirm", function() {
    return {
        require: "ngModel",
        scope: {
            passwordConfirm: '='
        },
        link: function(scope, element, attributes, controller) {
            scope.$watch(function(){
                var combined;

                if(scope.passwordConfirm || controller.$viewValue) {
                    combined = scope.passwordConfirm + '_' + controller.$viewValue;
                }
                return combined;
            }, function(value) {
                if(value) {
                    controller.$parsers.unshift(function (viewValue) {
                        var origin = scope.passwordConfirm;
                        if (origin !== viewValue) {
                            controller.$setValidity('passwordConfirm', false);
                            return undefined;
                        } else {
                            controller.$setValidity('passwordConfirm', true);
                            return viewValue;
                        }
                    })
                }
            })
        }
    };
});
appTodos.factory('Lists', function ($http) {
    var mainUrl = 'http://api.tutorials.loc/api/lists.php';
    var get = function ($_id, $filter) {
        var $url = mainUrl;
        if (typeof $_id != 'undefined' && $_id != null) {
            $url = mainUrl + '?_id=' + $_id;
            if (typeof $filter != 'undefined' && $filter.length > 0) {
                $url = $url + '&' + $filter;
            }
        } else if (typeof $filter != 'undefined' && $filter.length > 0) {
            $url = $url + '?' + $filter;
        }
        return $http
            .get($url)
            .then(
                function (response) {
                    return response.data;
                }, function (response) {
                    console.log('Error: ');
                    console.log(response);
                    return response;
                }
            );
    };
    var post = function (user) {
        return $http.post(mainUrl, user)
            .then(
                function (response) {
                    return response.data;
                },
                function (response) {
                    console.log('Error: ');
                    console.log(response.data);
                    return response;
                }
            );
    };
    var put = function ($_id, $user) {
        return $http.put(mainUrl + '?_id=' + $_id, $user)
            .then(
                function (response) {
                    return response.data;
                },
                function (response) {
                    console.log('Error: ');
                    console.log(response.data);
                    return response;
                }
            );
    };
    var remove = function ($_id) {
        var $url = mainUrl;
        if (typeof $_id != 'undefined') {
            $url = mainUrl + '?_id=' + $_id;
        }
        return $http.delete($url)
            .then(
                function (response) {
                    return response.data;
                }, function (response) {
                    console.log('Error: ');
                    console.log(response);
                    return response;
                }
            );
    };
    return {
        get: get,
        post: post,
        put: put,
        remove: remove
    }
});
appTodos.config(function ($routeProvider, $locationProvider) {
    $routeProvider
        .when('/', {
            templateUrl: 'pages/home.html',
            controller: 'homeController',
            title: 'Todos - Home Page'
        })
        .when('/registration', {
            templateUrl: 'pages/registration.html',
            controller: 'registrationController',
            title: 'Todos - Registration Page'
        })
        .when('/login', {
            templateUrl: 'pages/login.html',
            controller: 'loginController',
            title: 'Todos - Login Page'
        })
        .when('/about', {
            templateUrl: 'pages/about.html',
            controller: 'aboutController',
            title: 'Todos - About Page'
        })
        .when('/users', {
            templateUrl: 'pages/users/users.html',
            controller: 'UsersController',
            title: 'Todos - Users Page'
        })
        .when('/todos', {
            templateUrl: 'pages/todos/index.html',
            controller: 'TodosController',
            title: 'Todos - Todos Page'
        })
        .otherwise({
            redirectTo: '/'
        });
    $locationProvider.html5Mode(true);
});
appTodos.factory('accessFactory', function ($localStorage) {
    var object = {};
    var userRoleUrls = ['home', 'todos', 'about', 'logout'];
    var guestRoleUrls = ['home', 'about', 'login', 'registration'];
    var adminRoleUrls = ['home', 'todos', 'about', 'users', 'logout'];
    object.checkPermission = function (url) {
        var permission = [];
        if ($localStorage.userRole == 'admin') {
            permission = adminRoleUrls;
        } else if ($localStorage.userRole == 'user') {
            permission = userRoleUrls;
        } else {
            permission = guestRoleUrls;
        }
        if (permission.indexOf(url) !== -1) {
            return true;
        }
        return false;
    };
    return object;
});
appTodos.run(function ($location, $rootScope, $localStorage, accessFactory) {
    $rootScope.$on('$routeChangeSuccess', function (event, current, previous) {
        $rootScope.title = current.$$route.title;
        var currentUrl = current.$$route.originalPath.substring(1);
        if(currentUrl.length == 0) {
            currentUrl = 'home';
        }
        if(!accessFactory.checkPermission(currentUrl)) {
            if (typeof previous === 'undefined') {
                $location.path('/');
            } else {
                $location.path(previous.$$route.originalPath);
            }
        }
    });
    $localStorage.$default({
        isAuthenticated: false,
        userRole: 'guest',
        userId: null,
        opened: ''
    });
    $rootScope.logout = function () {
        $localStorage.$reset({
            isAuthenticated: false,
            userRole: 'guest',
            userId: null,
            opened: ''
        });
        $location.path('/');
    };
});
appTodos.factory('Todos', function ($http) {
    var mainUrl = 'http://api.tutorials.loc/api/todos.php';
    var get = function ($_id, $filter) {
        var $url = mainUrl;
        if (typeof $_id != 'undefined' && $_id != null) {
            $url = mainUrl + '?_id=' + $_id;
            if (typeof $filter != 'undefined' && $filter.length > 0) {
                $url = $url + '&' + $filter;
            }
        } else if (typeof $filter != 'undefined' && $filter.length > 0) {
            $url = $url + '?' + $filter;
        }
        return $http
            .get($url)
            .then(
                function (response) {
                    return response.data;
                }, function (response) {
                    console.log('Error: ');
                    console.log(response);
                    return response;
                }
            );
    };
    var post = function (todo) {
        return $http.post(mainUrl, todo)
            .then(
                function (response) {
                    return response.data;
                },
                function (response) {
                    console.log('Error: ');
                    console.log(response.data);
                    return response;
                }
            );
    };
    var put = function ($_id, $todo) {
        return $http.put(mainUrl + '?_id=' + $_id, $todo)
            .then(
                function (response) {
                    return response.data;
                },
                function (response) {
                    console.log('Error: ');
                    console.log(response.data);
                    return response;
                }
            );
    };
    var remove = function ($_id) {
        var $url = mainUrl;
        if (typeof $_id != 'undefined') {
            $url = mainUrl + '?_id=' + $_id;
        }
        return $http.delete($url)
            .then(
                function (response) {
                    return response.data;
                }, function (response) {
                    console.log('Error: ');
                    console.log(response);
                    return response;
                }
            );
    };
    return {
        get: get,
        post: post,
        put: put,
        remove: remove
    }
});
appTodos.factory('Users', function ($http) {
    var get = function ($_id, $filter) {
        var $url = 'http://api.tutorials.loc/api/users.php';
        if(typeof $_id != 'undefined' && $_id != null) {
            $url = 'http://api.tutorials.loc/api/users.php?_id=' + $_id;
            if(typeof $filter != 'undefined' && $filter.length > 0) {
                $url = $url + '&' + $filter;
            }
        } else if(typeof $filter != 'undefined' && $filter.length > 0) {
            $url = $url + '?' + $filter;
        }
        return $http
            .get($url)
            .then(
                function (response) {
                    return response.data;
                }, function (response) {
                    console.log('Error: ');
                    console.log(response);
                    return response;
                }
            );
    };
    var post = function (user) {
        return $http.post('http://api.tutorials.loc/api/users.php', user)
            .then(
                function(response){
                    return response.data;
                },
                function(response){
                    console.log('Error: ');
                    console.log(response.data);
                    return response;
                }
            );
    };
    var put = function($_id, $user){
        return $http.put('http://api.tutorials.loc/api/users.php?_id=' + $_id, $user)
            .then(
                function(response){
                    return response.data;
                },
                function(response){
                    console.log('Error: ');
                    console.log(response.data);
                    return response;
                }
            );
    };
    var remove = function($_id) {
        var $url = 'http://api.tutorials.loc/api/users.php';
        if(typeof $_id != 'undefined') {
            $url = 'http://api.tutorials.loc/api/users.php?_id=' + $_id;
        }
        return $http.delete($url)
            .then(
                function (response) {
                    return response.data;
                }, function (response) {
                    console.log('Error: ');
                    console.log(response);
                    return response;
                }
            );
    };
    var login = function(user) {
        return $http.post('http://api.tutorials.loc/api/login.php', user)
            .then(
                function(response){
                    return response.data;
                },
                function(response){
                    console.log('Error: ');
                    console.log(response);
                    return response;
                }
            );
    };
    return {
        get: get,
        post: post,
        put: put,
        remove: remove,
        login: login
    }
});